<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>vanilla-light Demo</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <h1>vanilla-light</h1>
  <p>Simple demo: auth, user, KV, S3, and LLM chat.</p>

  <section>
    <b>Auth</b>
    <div>logged in? <span id="logged">no</span> | user: <span id="who">-</span></div>
    <div class="row">
      <button id="auth0-login">Auth0 Login</button>
      <button id="bearer-register">Bearer Register</button>
      <button id="bearer-login">Bearer Login</button>
      <button id="do-logout">Logout</button>
      <button id="show-me">Show User</button>
    </div>
    <pre id="me">null</pre>
  </section>

  <section>
    <b>KV</b>
    <div class="row">
      <input id="k" placeholder="key" value="demo-key">
      <input id="v" placeholder="value" value="hello">
      <button id="kv-set">Set</button>
      <button id="kv-get">Get</button>
      <button id="kv-del">Delete</button>
    </div>
    <pre id="kv">null</pre>
  </section>

  <section>
    <b>S3 / R2</b>
    <file-widget></file-widget>
  </section>

  <section>
    <b>LLM Chat</b>
    <textarea id="prompt">Say hi in one sentence.</textarea>
    <div class="row">
      <button id="chat-send">Send</button>
    </div>
    <pre id="chat">null</pre>
  </section>

  <script type="module">
    import { $, $$, fetchJson, get, set, del, me, loginAuth0, registerBearer, loginBearer, logout } from "/client.js";

    const show = (id, v) => $(id).textContent = typeof v === "string" ? v : JSON.stringify(v, null, 2);

    async function refreshAuth() {
      const u = await me();
      $("#logged").textContent = u ? "yes" : "no";
      $("#who").textContent = u?.name || u?.email || u?.sub || "-";
      return u;
    }

    async function bearerRegisterFlow() {
      const email = prompt("email") || `demo-${Date.now()}@example.com`;
      show("#me", await registerBearer(email));
      await refreshAuth();
    }

    async function bearerLoginFlow() {
      const sub = prompt("sub (from register response)");
      if (!sub) return;
      show("#me", await loginBearer(sub));
      await refreshAuth();
    }

    async function logoutFlow() {
      await logout();
      show("#me", null);
      await refreshAuth();
    }

    async function chatFlow() {
      const body = { model: "openai/gpt-4o-mini", messages: [{ role: "user", content: $("#prompt").value }] };
      show("#chat", await fetchJson(`${window.api_url}/llm/chat`, body));
    }

    if ($$("#auth0-login").length) {
      $("#auth0-login").addEventListener("click", loginAuth0);
      $("#bearer-register").addEventListener("click", bearerRegisterFlow);
      $("#bearer-login").addEventListener("click", bearerLoginFlow);
      $("#do-logout").addEventListener("click", logoutFlow);
      $("#show-me").addEventListener("click", async () => show("#me", await refreshAuth()));
      $("#kv-set").addEventListener("click", async () => show("#kv", await set($("#k").value, $("#v").value)));
      $("#kv-get").addEventListener("click", async () => show("#kv", await get($("#k").value)));
      $("#kv-del").addEventListener("click", async () => show("#kv", await del($("#k").value)));
      $("#chat-send").addEventListener("click", chatFlow);

      refreshAuth();
    }
  </script>
</body>
</html>
